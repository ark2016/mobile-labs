import 'package:flutter/cupertino.dart';
import 'package:flutter/services.dart';
import 'package:mailer/mailer.dart';
import 'package:mailer/smtp_server.dart';

class Lab10 extends StatefulWidget {
  const Lab10({super.key});

  @override
  State<Lab10> createState() => _Lab10State();
}

class Recipient {
  String name;
  String email;

  Recipient({required this.name, required this.email});
}

class _Lab10State extends State<Lab10> {
  final List<Recipient> _recipients = [
    Recipient(name: '–î–∞–Ω–∏–ª–∞ –ü–∞–≤–ª–æ–≤–∏—á', email: 'posevin@bmstu.ru'),
    Recipient(name: '–î–∞–Ω–∏–ª–∞ –ü–∞–≤–ª–æ–≤–∏—á', email: 'danila@posevin.com'),
    Recipient(name: '–ê—Ä–∫–∞–¥–∏–π', email: '7dq9tyom7ze3@mail.ru'),
    Recipient(name: '–ï–≥–æ—Ä', email: 'egorrr.pro@yandex.ru'),
  ];

  final TextEditingController _messageController = TextEditingController(
    text: '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º!',
  );

  bool _isSending = false;
  String _statusMessage = '';

  // SMTP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  final String _smtpUsername = 'A6611688@yandex.ru';
  final String _smtpPassword = 'yqgnypaygncrbvmz';
  final String _smtpServer = 'smtp.yandex.ru';
  final int _smtpPort = 587;

  @override
  void dispose() {
    _messageController.dispose();
    super.dispose();
  }

  void _addRecipient() {
    setState(() {
      _recipients.add(Recipient(name: '–ù–æ–≤—ã–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å', email: 'example@mail.ru'));
    });
  }

  void _removeRecipient(int index) {
    setState(() {
      _recipients.removeAt(index);
    });
  }


  String _buildHtmlMessage(String name, String messageText) {
    return '''
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    .container {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .logo {
      max-width: 150px;
      height: auto;
    }
    h1 {
      color: #2c3e50;
      font-family: 'Georgia', serif;
      font-size: 32px;
      margin: 20px 0;
    }
    .greeting {
      color: #e74c3c;
      font-family: 'Courier New', monospace;
      font-size: 24px;
      font-weight: bold;
      margin: 15px 0;
    }
    .message-body {
      color: #34495e;
      font-family: 'Verdana', sans-serif;
      font-size: 16px;
      line-height: 1.6;
      margin: 20px 0;
    }
    .highlight {
      background-color: #f39c12;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-family: 'Arial Black', sans-serif;
    }
    .fancy-text {
      color: #9b59b6;
      font-family: 'Comic Sans MS', cursive;
      font-size: 20px;
      font-style: italic;
    }
    .footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #3498db;
      color: #7f8c8d;
      font-size: 14px;
      text-align: center;
    }
    .signature {
      color: #16a085;
      font-family: 'Trebuchet MS', sans-serif;
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="cid:logo@lab10" class="logo" alt="Logo"/>
    </div>

    <h1>üìß –ü–∏—Å—å–º–æ –∏–∑ Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h1>

    <div class="greeting">–ü—Ä–∏–≤–µ—Ç, $name!</div>

    <div class="message-body">
      <p>$messageText</p>

      <p class="fancy-text">
        –≠—Ç–æ –ø–∏—Å—å–º–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞!
      </p>

      <p>
        –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <span class="highlight">–≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</span>,
        <strong>–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç</strong>,
        <em>–∫—É—Ä—Å–∏–≤</em>, –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.
      </p>

      <p style="color: #e67e22; font-size: 18px; font-family: 'Times New Roman', serif;">
        –ö–∞–∂–¥—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å!
      </p>
    </div>

    <div class="signature">
      –° –Ω–∞–∏–ª—É—á—à–∏–º–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è–º–∏,<br>
      –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    </div>

    <div class="footer">
      –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${DateTime.now().toString()}<br>
      Powered by Flutter & Mailer
    </div>
  </div>
</body>
</html>
''';
  }

  Future<void> _sendEmails() async {
    if (_recipients.isEmpty) {
      setState(() {
        _statusMessage = '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è';
      });
      return;
    }

    setState(() {
      _isSending = true;
      _statusMessage = '–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º...';
    });

    try {
      print('=== SMTP –û—Ç–ø—Ä–∞–≤–∫–∞ ===');
      print('–°–µ—Ä–≤–µ—Ä: $_smtpServer:$_smtpPort');
      print('–û—Ç: $_smtpUsername');
      print('–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ${_recipients.length}');

      final smtpServer = SmtpServer(
        _smtpServer,
        port: _smtpPort,
        ssl: false, // –ü–æ—Ä—Ç 587 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç STARTTLS, –∞ –Ω–µ SSL
        username: _smtpUsername,
        password: _smtpPassword,
        allowInsecure: false,
      );

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø –∏–∑ assets
      Uint8List? logoBytes;
      try {
        final ByteData data = await rootBundle.load('assets/images/emblem.png');
        logoBytes = data.buffer.asUint8List();
        print('–õ–æ–≥–æ—Ç–∏–ø –∑–∞–≥—Ä—É–∂–µ–Ω: ${logoBytes.length} –±–∞–π—Ç');
      } catch (e) {
        print('–õ–æ–≥–æ—Ç–∏–ø –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω: $e');
      }

      int successCount = 0;
      int failCount = 0;

      for (var recipient in _recipients) {
        try {
          final message = Message()
            ..from = Address(_smtpUsername, 'Flutter Lab10')
            ..recipients.add(recipient.email)
            ..subject = '–ü—Ä–∏–≤–µ—Ç ${recipient.name}'
            ..html = _buildHtmlMessage(recipient.name, _messageController.text);

          // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø, –µ—Å–ª–∏ –æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω
          if (logoBytes != null) {
            message.attachments = [
              StreamAttachment(Stream.value(logoBytes), 'image/png', fileName: 'emblem.png')
                ..location = Location.inline
                ..cid = '<logo@lab10>'
            ];
          }

          await send(message, smtpServer).timeout(
            const Duration(seconds: 30),
            onTimeout: () {
              throw Exception('Timeout –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–∏—Å—å–º–∞');
            },
          );

          successCount++;
          print('‚úì –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${recipient.email}');
        } catch (e) {
          failCount++;
          print('‚úó –û—à–∏–±–∫–∞ –¥–ª—è ${recipient.email}: $e');
        }
      }

      setState(() {
        _isSending = false;
        _statusMessage = '–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: $successCount, –û—à–∏–±–æ–∫: $failCount';
      });
    } on MailerException catch (e) {
      print('MailerException: ${e.message}');
      for (var p in e.problems) {
        print('  ${p.code}: ${p.msg}');
      }
      String errorDetails = '–û—à–∏–±–∫–∞ SMTP: ${e.message}';
      setState(() {
        _isSending = false;
        _statusMessage = errorDetails;
      });
    } catch (e) {
      print('–û–±—â–∞—è –æ—à–∏–±–∫–∞: $e');
      setState(() {
        _isSending = false;
        _statusMessage = '–û—à–∏–±–∫–∞: $e';
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return CupertinoPageScaffold(
      navigationBar: const CupertinoNavigationBar(
        middle: Text('–õ–∞–± 10 - Email SMTP'),
      ),
      child: SafeArea(
        child: Column(
          children: [
            Expanded(
              child: ListView(
                primary: false,
                padding: const EdgeInsets.all(16),
                children: [
                  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
                  const Text(
                    '–ü–æ–ª—É—á–∞—Ç–µ–ª–∏',
                    style: TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 10),

                  // –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
                  for (var entry in _recipients.asMap().entries)
                    Builder(
                      builder: (context) {
                        int index = entry.key;
                        Recipient recipient = entry.value;

                        return Container(
                      margin: const EdgeInsets.only(bottom: 10),
                      decoration: BoxDecoration(
                        color: CupertinoColors.systemGrey6,
                        borderRadius: BorderRadius.circular(10),
                      ),
                      child: Padding(
                        padding: const EdgeInsets.all(12),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Expanded(
                                  child: Text(
                                    '–ü–æ–ª—É—á–∞—Ç–µ–ª—å ${index + 1}',
                                    style: const TextStyle(
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ),
                                CupertinoButton(
                                  padding: EdgeInsets.zero,
                                  onPressed: () => _removeRecipient(index),
                                  child: const Icon(
                                    CupertinoIcons.delete,
                                    color: CupertinoColors.destructiveRed,
                                  ),
                                ),
                              ],
                            ),
                            CupertinoTextField(
                              placeholder: '–ò–º—è',
                              controller: TextEditingController(text: recipient.name),
                              onChanged: (value) {
                                setState(() {
                                  _recipients[index].name = value;
                                });
                              },
                            ),
                            const SizedBox(height: 8),
                            CupertinoTextField(
                              placeholder: 'Email',
                              controller: TextEditingController(text: recipient.email),
                              keyboardType: TextInputType.emailAddress,
                              onChanged: (value) {
                                setState(() {
                                  _recipients[index].email = value;
                                });
                              },
                            ),
                          ],
                        ),
                      ),
                    );
                      },
                    ),

                  // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                  CupertinoButton(
                    onPressed: _addRecipient,
                    child: const Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(CupertinoIcons.add_circled),
                        SizedBox(width: 8),
                        Text('–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è'),
                      ],
                    ),
                  ),

                  const SizedBox(height: 20),

                  // –ü–æ–ª–µ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –ø–∏—Å—å–º–∞
                  const Text(
                    '–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞',
                    style: TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 10),
                  CupertinoTextField(
                    controller: _messageController,
                    placeholder: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞...',
                    maxLines: 5,
                    padding: const EdgeInsets.all(12),
                  ),

                  const SizedBox(height: 20),

                  // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö SMTP
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: CupertinoColors.systemBlue.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(10),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text(
                          '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ SMTP',
                          style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
                        ),
                        const SizedBox(height: 8),
                        Text('–°–µ—Ä–≤–µ—Ä: $_smtpServer:$_smtpPort (STARTTLS)'),
                        Text('–û—Ç: $_smtpUsername'),
                        const Text('–§–æ—Ä–º–∞—Ç: HTML —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º'),
                      ],
                    ),
                  ),

                  const SizedBox(height: 20),

                  // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
                  CupertinoButton.filled(
                    onPressed: _isSending ? null : _sendEmails,
                    child: _isSending
                        ? const Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              CupertinoActivityIndicator(color: CupertinoColors.white),
                              SizedBox(width: 10),
                              Text('–û—Ç–ø—Ä–∞–≤–∫–∞...'),
                            ],
                          )
                        : const Text('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–∞'),
                  ),

                  const SizedBox(height: 10),

                  // –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏
                  if (_statusMessage.isNotEmpty)
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: _statusMessage.contains('–£—Å–ø–µ—à–Ω–æ')
                            ? CupertinoColors.systemGreen.withOpacity(0.2)
                            : CupertinoColors.systemRed.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(10),
                      ),
                      child: Text(
                        _statusMessage,
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          color: _statusMessage.contains('–£—Å–ø–µ—à–Ω–æ')
                              ? CupertinoColors.systemGreen.darkColor
                              : CupertinoColors.systemRed.darkColor,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}
